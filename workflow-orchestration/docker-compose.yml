volumes:
    ny_taxi_postgres_data:
        driver: local
    kestra_postgres_data:
        driver: local
    kestra_data:
        driver: local

services:
    pgdatabase:
        image: postgres:18
        container_name: ny_taxi_postgres
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: ny_taxi
            POSTGRES_INITDB_ARGS: "-c shared_buffers=256MB"
        ports:
            - "5432:5432"
        volumes:
            - ny_taxi_postgres_data:/var/lib/postgresql
            - ../pipeline:/pipeline
        networks:
            - data_engineering_network
        command: postgres

    pgadmin:
        image: dpage/pgadmin4
        container_name: pgadmin
        environment:
            - PGADMIN_DEFAULT_EMAIL=admin@admin.com
            - PGADMIN_DEFAULT_PASSWORD=root
        ports:
            - "8085:80"
        networks:
            - data_engineering_network
        depends_on:
            - pgdatabase

    kestra_postgres:
        image: postgres:18
        container_name: kestra_postgres
        volumes:
            - kestra_postgres_data:/var/lib/postgresql
        environment:
            POSTGRES_DB: kestra
            POSTGRES_USER: kestra
            POSTGRES_PASSWORD: kestra
            POSTGRES_INITDB_ARGS: "-c shared_buffers=256MB"
        ports:
            - "5433:5432"
        networks:
            - data_engineering_network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
            interval: 30s
            timeout: 10s
            retries: 10
        command: postgres

    kestra:
        image: kestra/kestra:v1.1
        container_name: kestra
        pull_policy: always
        user: "root"
        command: server standalone
        volumes:
            - kestra_data:/app/storage
            - /var/run/docker.sock:/var/run/docker.sock
            - /tmp/kestra-wd:/tmp/kestra-wd
            - ../pipeline:/pipeline
        environment:
            KESTRA_CONFIGURATION: |
                datasources:
                    postgres:
                        url: jdbc:postgresql://kestra_postgres:5432/kestra
                        driverClassName: org.postgresql.Driver
                        username: kestra
                        password: kestra
                kestra:
                    server:
                        basicAuth:
                            username: "admin@kestra.io"
                            password: Admin1234
                    repository:
                        type: postgres
                    storage:
                        type: local
                        local:
                            basePath: "/app/storage"
                    queue:
                        type: postgres
                    tasks:
                        tmpDir:
                            path: /tmp/kestra-wd/tmp
                    url: http://localhost:8080/
        ports:
            - "8080:8080"
            - "8081:8081"
        networks:
            - data_engineering_network
        depends_on:
            kestra_postgres:
                condition: service_healthy
            pgdatabase:
                condition: service_started

networks:
    data_engineering_network:
        driver: bridge
